#!/usr/bin/env python3
"""
ALL SCAN
Network Scanner (Kali Linux)
Backend: Nmap
"""

import re
import sys
import subprocess
import time
import shutil
import os

# ================= COLORS =================
RED = "\033[91m"
YELLOW = "\033[93m"
GREEN = "\033[92m"
CYAN = "\033[96m"
RESET = "\033[0m"

# ================= CONSTANTS =================
REPORT_DIR = "/home/kali/allsacnreport"

# ================= CHECK NMAP =================
if shutil.which("nmap") is None:
    print(f"{RED}[-] Nmap is not installed. Please install Nmap first.{RESET}")
    sys.exit(1)

# ================= BANNER =================
banner = """
========================================
 ALL SCAN
 Network Scanner (Kali Linux)
========================================
"""
print(CYAN + banner + RESET)

# ================= INPUT =================
target = input("Enter Target IP / Range: ").strip()

patterns = [
    r"^(?:\d{1,3}\.){3}\d{1,3}$",
    r"^(?:\d{1,3}\.){3}\d{1,3}/\d{1,2}$",
    r"^(?:\d{1,3}\.){3}\d{1,3}-\d{1,3}$"
]

if not any(re.match(p, target) for p in patterns):
    print(f"{RED}[-] Invalid IP or range format{RESET}")
    sys.exit(1)

# ================= SCAN =================
print(f"\n{CYAN}[+] Start scanning...{RESET}\n")
start_time = time.time()

cmd = ["nmap", "-sS", "-sV", "-sC", "-O", "-Pn", target]
proc = subprocess.run(
    cmd,
    stdout=subprocess.PIPE,
    stderr=subprocess.STDOUT,
    text=True
)

end_time = time.time()

# ================= PARSE OUTPUT =================
clean_lines = []
open_ports = []
services = set()
findings = []

RISK_PORTS = {
    21: "FTP (clear-text authentication)",
    23: "Telnet (unencrypted)",
    445: "SMB exposed",
    3389: "RDP exposed",
    3306: "MySQL exposed",
    5900: "VNC exposed"
}

for line in proc.stdout.splitlines():
    if line.startswith(("Starting Nmap", "OS and Service detection performed", "Nmap done:")):
        continue

    clean_lines.append(line)

    if "/tcp" in line and "open" in line:
        parts = line.split()
        try:
            port = int(parts[0].split("/")[0])
            service = parts[2]
            open_ports.append(port)
            services.add(service)

            if port in RISK_PORTS:
                findings.append(f"Port {port}: {RISK_PORTS[port]}")
        except:
            pass

scan_output = "\n".join(clean_lines)

# ================= SUMMARY =================
summary = f"""
------------- SCAN SUMMARY -------------
Target        : {target}
Open Ports    : {len(open_ports)}
Services      : {", ".join(sorted(services)) if services else "None"}
Scan Duration : {round(end_time - start_time, 2)} seconds
---------------------------------------
"""

# ================= FINDINGS =================
if findings:
    findings_text = "[!] Potentially Insecure Services Detected:\n"
    for f in findings:
        findings_text += f"  - {f}\n"
else:
    findings_text = "[+] No obvious insecure services detected\n"

# ================= FULL REPORT =================
full_report = (
    banner
    + f"Target: {target}\n\n"
    + "----- SCAN OUTPUT -----\n"
    + scan_output
    + "\n\n"
    + summary
    + "\n"
    + findings_text
)

# ================= DISPLAY =================
print(scan_output)
print(CYAN + summary + RESET)

if findings:
    print(RED + findings_text + RESET)
else:
    print(GREEN + findings_text + RESET)

# ================= SAVE REPORT (AUTO) =================
save = input("\nSave full report? (y/n): ").lower()

if save == "y":
    name = input("Report file name (without extension): ").strip()

    if not name:
        print(f"{YELLOW}[-] Invalid file name{RESET}")
        sys.exit(0)

    # Ensure directory exists
    os.makedirs(REPORT_DIR, exist_ok=True)

    # Check write permission
    if not os.access(REPORT_DIR, os.W_OK):
        print(f"{RED}[-] Report directory is not writable:{RESET}")
        print(f"{RED}    {REPORT_DIR}{RESET}")
        print("Fix by running:")
        print("sudo chown -R kali:kali /home/kali/allsacnreport")
        sys.exit(1)

    path = os.path.join(REPORT_DIR, name + ".txt")

    with open(path, "w") as f:
        f.write(full_report)

    print(f"{GREEN}[+] Report saved successfully{RESET}")
    print(f"{CYAN}[+] Location: {path}{RESET}")
